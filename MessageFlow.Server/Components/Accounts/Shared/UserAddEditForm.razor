@* @attribute [Authorize(Roles = "Admin, SuperAdmin")]
@rendermode RenderMode.InteractiveServer

@inject IUserManagementService UserManagementService
@inject CompanyManagementService CompanyManagementService
@inject NavigationManager NavigationManager
@inject ILogger<UserAddEditForm> Logger

@if(ApplicationUser is not null){
    <EditForm Model="ApplicationUser" OnValidSubmit="HandleSubmit" FormName="AddEditUserForm">
        <h3>
            @Title
        </h3>
        @if (IsEditMode)
        {
            <input type="hidden" name=" ApplicationUser.Id" value="@ApplicationUser.Id" />
        }

        @if (!string.IsNullOrEmpty(DisplayMessage))
        {
            var statusMessageClass = DisplayMessage.StartsWith("Error") ? "danger" : "success";
            <div class="alert alert-@statusMessageClass" role="alert">
                @DisplayMessage
            </div>
        }

        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="form-floating mb-3">
            <InputSelect @bind-Value="SelectedCompanyId" class="form-control"
                         disabled="@(companies.Count == 1 )">
                <option value="">Select a Company</option>
                @foreach (var company in companies)
                {
                    <option value="@company.Id">@company.CompanyName</option>
                }
            </InputSelect>
            <label for="company">Company</label>
            <ValidationMessage For="() => ApplicationUser.CompanyDTO" class="text-danger" />
        </div>


        <!-- Username -->
        <div class="form-floating mb-3">
            <InputText @bind-Value="ApplicationUser.UserName" class="form-control" placeholder="Enter Username" />
            <label for="username">Username</label>
            <ValidationMessage For="() => ApplicationUser.UserName" class="text-danger" />
        </div>

        <!-- Email -->
        <div class="form-floating mb-3">
            <InputText @bind-Value="ApplicationUser.UserEmail" class="form-control" placeholder="Enter Email" />
            <label for="email">Email</label>
            <ValidationMessage For="() => ApplicationUser.UserEmail" class="text-danger" />
        </div>

        <!-- Phone Number -->
        <div class="form-floating mb-3">
            <InputText @bind-Value="ApplicationUser.PhoneNumber" class="form-control" placeholder="Enter Phone Number" />
            <label for="phoneNumber">Phone Number</label>
            <ValidationMessage For="() => ApplicationUser.PhoneNumber" class="text-danger" />
        </div>

        <!-- Password -->
        <div class="form-floating mb-3">
            <InputText @bind-Value="UsrPass"
            type="password"
            class="form-control"
            placeholder="Enter Password" />
            <label for="password">Password</label>
            <ValidationMessage For="() => UsrPass" class="text-danger" />
        </div>

        <!-- Role Dropdown -->
        <div class="form-floating mb-3">
            <InputSelect @bind-Value="ApplicationUser.Role" class="form-control">
                <option value="">Select a Role</option>
                @foreach (var role in displayedRoles)
                {
                    <option value="@role">@role</option>                    
                }
            </InputSelect>
            <label for="role">Role</label>
            <ValidationMessage For="() => ApplicationUser.Role" class="text-danger" />
        </div>

        <!-- Lockout Enabled Checkbox -->
        <div class="form-check mb-3">
            <InputCheckbox @bind-Value="ApplicationUser.LockoutEnabled" class="form-check-input" id="lockoutEnabled" />
            <label class="form-check-label" for="lockoutEnabled">Lockout Enabled</label>
        </div>

        <!-- Submit Button -->
        <button type="submit" class="w-100 btn btn-lg btn-primary">Submit</button>
    </EditForm>
}


@code {

    [Parameter]
    public bool IsEditMode { get; set; } = false;
    [Parameter]
    public string UserId { get; set; }
    [Parameter]
    public string? Message { get; set; }
    [Parameter]
    public EventCallback<ApplicationUserDTO> OnValidSubmit { get; set; }

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;
    private string Title => IsEditMode ? $"Edit User {ApplicationUser.UserName}" : "Create New User";
    // private bool isSuperAdmin = false;
    private ApplicationUserDTO ApplicationUser = new();
    private List<CompanyDTO> companies = new();
    private List<string> availableRoles = new();
    private List<string> displayedRoles = new();
    private string UsrPass = string.Empty;
    [Required(ErrorMessage = "Please select a role.")]
    private string? messageFromCookie;
    private string? DisplayMessage => Message ?? messageFromCookie;

    protected override async Task OnInitializedAsync()
    {

        companies = await CompanyManagementService.GetAllCompaniesAsync();
        // When in edit mode, fetch the user data and prepopulate fields
        if (IsEditMode && !string.IsNullOrEmpty(UserId))
        {
            // Load the user's details by their Document_id
            ApplicationUser = await UserManagementService.GetUserByIdAsync(UserId);
            if (ApplicationUser == null)
            {
                SetErrorMessage(new List<string> { "User not found" });
                return;
            }
            // ✅ Preselect the user's company after loading the companies
            SelectedCompanyId = ApplicationUser.CompanyId ?? companies.FirstOrDefault()?.Id;
        }
        else if (companies.Count == 1)
        {
            // ✅ Auto-select the single available company in create mode
            SelectedCompanyId = companies.First().Id;
        }

        availableRoles = await UserManagementService.GetAvailableRolesAsync();
        // Remove SuperAdmin role if logged-in user is not a SuperAdmin or selected company is not company 00000
        UpdateSuperAdminRole();

        // // Check for any status messages stored in cookies
        // if (HttpContext != null && HttpContext.Request.Cookies.ContainsKey(IdentityRedirectManager.StatusCookieName))
        // {
        //     messageFromCookie = HttpContext.Request.Cookies[IdentityRedirectManager.StatusCookieName];
        //     HttpContext.Response.Cookies.Delete(IdentityRedirectManager.StatusCookieName);
        // }
    }

    private async Task HandleSubmit()
    {
        try
        {
            (bool success, string errorMessage) result;

            if (!IsEditMode)
            {
                // Create user
                result = await UserManagementService.CreateUserAsync(ApplicationUser, UsrPass);
            }
            else
            {
                // Update user
                result = await UserManagementService.UpdateUserAsync(ApplicationUser, UsrPass);
            }

            if (!result.success)
            {
                SetErrorMessage(new List<string> { result.errorMessage });
            }
            else
            {
                SetSuccessMessage(result.errorMessage);
                await Task.Delay(2000);
                if (OnValidSubmit.HasDelegate)
                {
                    await OnValidSubmit.InvokeAsync();
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "An error occurred while handling user creation/update.");
            SetErrorMessage(new List<string> { "An unexpected error occurred. Please try again." });
        }
    }

    private void UpdateSuperAdminRole()
    {
        const string superAdminCompanyId = "e68116f4-1588-4987-b4ab-c3a487200c25"; /// TO BE CHANGED TO GET THE ID FROM AZURE VAULT!!!!!

        displayedRoles = new List<string>(availableRoles);

        if (ApplicationUser.CompanyId != superAdminCompanyId)
        {
            // ❌ Remove "SuperAdmin" if company doesn't match
            displayedRoles.Remove("SuperAdmin");
        }
        else
        {
            // ✅ Add the original roles returned from the server
            if (!displayedRoles.Contains("SuperAdmin"))
            {
                displayedRoles = new List<string>(availableRoles);
            }
        }
        StateHasChanged();
    }

    private string SelectedCompanyId
    {
        get => ApplicationUser.CompanyId;
        set
        {
            if (ApplicationUser.CompanyId != value)
            {
                ApplicationUser.CompanyId = value;
                ApplicationUser.CompanyDTO = companies.FirstOrDefault(c => c.Id == value);
                UpdateSuperAdminRole();
            }
        }
    }


    
    private void SetErrorMessage(IEnumerable<string> errors)
    {
        Message = $"Error: {string.Join(", ", errors)}";
    }

    private void SetSuccessMessage(string message)
    {
        Message = message;
    }
}
 *@