@using System.ComponentModel.DataAnnotations
@rendermode RenderMode.InteractiveWebAssembly
@inject AuthenticationStateProvider AuthenticationStateProvider

<div class="new-conversations-list">
    <h4>New Conversations</h4>
    @if (isLoading)
    {
        <LoadingIndicator Message="Loading conversations..." IsDark="false" />
    }
    else
    {
        <ul>
            @foreach (var vm in FilteredConversations)
            {
                <li>
                    <img src="@vm.GetSourceIcon()" alt="@vm.GetSourceAltText()" class="me-2 source-icon" />
                    <span>Chat with @vm.Conversation.SenderUsername</span>
                    <button @onclick="async () => await AssignToSelf(vm)">Assign to Myself</button>
                </li>
            }
        </ul>
    }
</div>

@code {
    [Parameter, Required] public string? UserId { get; set; }
    [Parameter, Required] public string? TeamId { get; set; }
    [Parameter, Required] public HubConnection HubConnection { get; set; }
    [Parameter, Required] public ChatWindow ChatWindowRef { get; set; }

    private List<ConversationViewModel> Conversations = new();
    private bool isLoading = true;
    private IEnumerable<ConversationViewModel> FilteredConversations =>
    string.IsNullOrEmpty(TeamId)
        ? Conversations
        : Conversations.Where(vm => vm.Conversation.AssignedTeamId == TeamId);

    protected override void OnParametersSet()
    {
        if (HubConnection != null)
        {
            RegisterHandlers();
        }
    }

    public void RegisterHandlers()
    {
        if (HubConnection != null)
        {
            HubConnection.On<ConversationDTO>("NewConversationAdded", (conversation) =>
            {
                AddConversation(conversation);
            });

            HubConnection.On<ConversationDTO>("RemoveNewConversation", (conversation) =>
            {
                RemoveConversation(conversation);
            });

            HubConnection.On<List<ConversationDTO>>("LoadNewConversations", (newConversations) =>
           {
               LoadNewConversations(newConversations);
           });
        }
    }

    public void LoadNewConversations(List<ConversationDTO> dtoList)
    {
        isLoading = true;
        Conversations.Clear();

        foreach (var dto in dtoList)
        {
            AddConversation(dto);
        }
        isLoading = false;
        StateHasChanged();
    }

    public void AddConversation(ConversationDTO dto)
    {
        if (!Conversations.Any(c => c.Conversation.Id == dto.Id))
        {
            Conversations.Add(new ConversationViewModel(dto));
        }
        StateHasChanged();
    }

    public void RemoveConversation(ConversationDTO dto)
    {
        if (dto != null)
        {
            Conversations.RemoveAll(c => c.Conversation.Id == dto.Id);
            StateHasChanged();
        }
    }

    private async Task AssignToSelf(ConversationViewModel vm)
    {
        if (HubConnection is not null)
        {
            vm.Conversation.IsAssigned = true;
            vm.Conversation.AssignedUserId = UserId;

            await HubConnection.SendAsync("AssignConversationToUser", vm.Conversation.Id);
            Conversations.Remove(vm);
        }
        else
        {
            Console.WriteLine("hubConnection or UserId is null. Cannot assign conversation.");
        }
    }
}